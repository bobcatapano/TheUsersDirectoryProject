<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>User Directory</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
   
</head>

<body class="bg-light">
    <div class="container py-4">
        <h1 class="mb-4">User Accounts</h1>
        <div class="d-flex justify-content-between mb-3">
            <button id="newBtn" class="btn btn-primary">New User</button>
        </div>

        <div id="tableWrap">
            <table id="usersTable" class="table table-striped table-bordered align-middle d-none">
                <thead class="table-light">
                    <tr>
                        <th>First name</th>
                        <th>Last name</th>
                        <th>Email</th>
                        <th>User Name</th>
                        <th>Group</th>
                        <th style="width:150px;">Actions</th>
                    </tr>
                </thead>
                <tbody id="userTbody"></tbody>
            </table>
            <div id="emptyMsg" class="text-muted fst-italic d-none">
                No users yet. Click “New” to add one.
            </div>
        </div>
        <div class="d-flex align-items-center">
            <label for="pageSizeSelect" class="ms-3">Users per page:</label>
            <select id="pageSizeSelect" class="form-select d-inline-block w-auto">
                <option value="5">5</option>
                <option value="10" selected>10</option>
                <option value="20">20</option>
                <option value="50">50</option>
            </select>
        </div>

        <div id="paginationControls" class="d-flex justify-content-center mt-3"></div>

        <!-- Bootstrap Modal -->
        <div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <form id="newForm">
                        <div class="modal-header">
                            <h5 class="modal-title" id="modalTitle">New User</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="userId" name="userId" />

                            <div class="mb-3">
                                <label for="firstName" class="form-label">First name</label>
                                <input id="firstName" name="firstName" class="form-control" required />
                            </div>
                            <div class="mb-3">
                                <label for="lastName" class="form-label">Last name</label>
                                <input id="lastName" name="lastName" class="form-control" required />
                            </div>
                            <div class="mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input id="email" name="email" type="email" class="form-control" required />
                            </div>
                            <div class="mb-3">
                                <label for="userName" class="form-label">Username</label>
                                <div class="d-flex">
                                    <input id="userName" name="userName" class="form-control me-2" required />
                                    <button type="button" id="checkUsernameBtn" class="btn btn-outline-secondary">Check Username</button>
                                </div>
                            </div>

                            <!-- Password requirements -->
                            <div class="mb-2">
                                <label class="form-label">Password must include:</label>
                                <ul id="passwordChecklist" class="list-unstyled small">
                                    <li id="check-capital" class="text-danger">❌ At least one capital letter</li>
                                    <li id="check-length" class="text-danger">❌ At least 7 characters long</li>
                                    <li id="check-special" class="text-danger">❌ At least one special character (!@#$%)</li>
                                    <li id="check-number" class="text-danger">❌ At least one number</li>
                                </ul>
                            </div>

                            <div class="mb-3">
                                <label for="password" class="form-label">Password</label>
                                <input type="password" id="password" class="form-control" required />
                            </div>

                            <div class="mb-3">
                                <label for="confirmPassword" class="form-label">Confirm Password</label>
                                <input type="password" id="confirmPassword" class="form-control" required />
                                <div id="confirmMessage" class="small mt-1"></div>
                            </div>

                            <div class="mb-3">
                                <label for="groupId" class="form-label">Group</label>
                                <select id="groupId" name="groupId" class="form-select" required></select>
                            </div>

                            <div class="text-danger" id="formError" hidden></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" id="saveBtn" class="btn btn-primary" disabled>Save</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>


        <!-- Delete Confirmation Modal -->
        <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Confirm Delete</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p id="deleteMessage">Are you sure you want to delete this user?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit User Modal -->
        <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <form id="editForm">
                        <div class="modal-header">
                            <h5 class="modal-title" id="editModalLabel">Edit User</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" name="userId" id="editUserId">

                            <div class="mb-3">
                                <label for="editFirstName" class="form-label">First Name</label>
                                <input type="text" class="form-control" id="editFirstName" name="firstName" required>
                            </div>

                            <div class="mb-3">
                                <label for="editLastName" class="form-label">Last Name</label>
                                <input type="text" class="form-control" id="editLastName" name="lastName" required>
                            </div>

                            <div class="mb-3">
                                <label for="editEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="editEmail" name="email" required>
                            </div>

                            <div class="mb-3">
                                <label for="editUserName" class="form-label">User Name</label>
                                <input type="text" class="form-control" id="editUserName" name="userName" readonly>
                            </div>

                            <div class="mb-3">
                                <label for="editGroup" class="form-label">Group</label>
                                <select class="form-select" id="editGroup" name="groupId" required>
                                    <!-- Options will be filled dynamically -->
                                </select>
                            </div>

                            <!-- Password requirements checklist -->
                            <div class="mb-2">
                                <label class="form-label">Password must include:</label>
                                <ul id="editPasswordChecklist" class="list-unstyled small">
                                    <li id="edit-check-capital" class="text-danger">❌ At least one capital letter</li>
                                    <li id="edit-check-length" class="text-danger">❌ At least 7 characters long</li>
                                    <li id="edit-check-special" class="text-danger">❌ At least one special character (!@#$%)</li>
                                    <li id="edit-check-number" class="text-danger">❌ At least one number</li>
                                </ul>
                            </div>

                            <div class="mb-3">
                                <label for="editPassword" class="form-label">Password</label>
                                <input type="password" id="editPassword" class="form-control" required>
                            </div>

                            <div class="mb-3">
                                <label for="editConfirmPassword" class="form-label">Confirm Password</label>
                                <input type="password" id="editConfirmPassword" class="form-control" required>
                                <div id="editConfirmMessage" class="small mt-1"></div>
                            </div>

                            <div id="editFormError" class="text-danger small" hidden></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" id="editSaveBtn" class="btn btn-primary" disabled>Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Bootstrap JS bundle -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            const passwordInput = document.getElementById("password");
            const confirmInput = document.getElementById("confirmPassword");
            const saveBtn = document.getElementById("saveBtn");

            const checks = {
                capital: document.getElementById("check-capital"),
                length: document.getElementById("check-length"),
                special: document.getElementById("check-special"),
                number: document.getElementById("check-number"),
            };

            function validatePassword() {
                const pwd = passwordInput.value;

                const hasCapital = /[A-Z]/.test(pwd);
                const minLength = pwd.length >= 7;
                const hasSpecial = /[!@#$%]/.test(pwd);
                const hasNumber = /\d/.test(pwd);

                updateCheck(checks.capital, hasCapital);
                updateCheck(checks.length, minLength);
                updateCheck(checks.special, hasSpecial);
                updateCheck(checks.number, hasNumber);

                return hasCapital && minLength && hasSpecial && hasNumber;
            }

            function updateCheck(element, valid) {
                element.textContent = (valid ? "✅ " : "❌ ") + element.textContent.slice(2);
                element.classList.toggle("text-success", valid);
                element.classList.toggle("text-danger", !valid);
            }

            function validateConfirmPassword() {
                const msg = document.getElementById("confirmMessage");
                if (!confirmInput.value) {
                    msg.textContent = "";
                    return false;
                }
                if (confirmInput.value === passwordInput.value) {
                    msg.textContent = "✅ Passwords match";
                    msg.className = "text-success small";
                    return true;
                } else {
                    msg.textContent = "❌ Passwords do not match";
                    msg.className = "text-danger small";
                    return false;
                }
            }

            function updateSaveButton() {
                const passwordValid = validatePassword();
                const confirmValid = validateConfirmPassword();
                const requiredFieldsFilled = [...document.querySelectorAll("#newForm [required]")]
                    .every(input => input.value.trim() !== "");
                saveBtn.disabled = !(passwordValid && confirmValid && requiredFieldsFilled);
            }

            passwordInput.addEventListener("input", updateSaveButton);
            confirmInput.addEventListener("input", updateSaveButton);
            document.querySelectorAll("#newForm [required]").forEach(input => {
                input.addEventListener("input", updateSaveButton);
            });
        </script>
        <script>
            const editPasswordInput = document.getElementById("editPassword");
            const editConfirmInput = document.getElementById("editConfirmPassword");
            const editSaveBtn = document.getElementById("editSaveBtn");

            const editChecks = {
                capital: document.getElementById("edit-check-capital"),
                length: document.getElementById("edit-check-length"),
                special: document.getElementById("edit-check-special"),
                number: document.getElementById("edit-check-number"),
            };

            function validateEditPassword() {
                const pwd = editPasswordInput.value;

                const hasCapital = /[A-Z]/.test(pwd);
                const minLength = pwd.length >= 7;
                const hasSpecial = /[!@#$%]/.test(pwd);
                const hasNumber = /\d/.test(pwd);

                updateCheck(editChecks.capital, hasCapital);
                updateCheck(editChecks.length, minLength);
                updateCheck(editChecks.special, hasSpecial);
                updateCheck(editChecks.number, hasNumber);

                return hasCapital && minLength && hasSpecial && hasNumber;
            }

            function validateEditConfirmPassword() {
                const msg = document.getElementById("editConfirmMessage");
                if (!editConfirmInput.value) {
                    msg.textContent = "";
                    return false;
                }
                if (editConfirmInput.value === editPasswordInput.value) {
                    msg.textContent = "✅ Passwords match";
                    msg.className = "text-success small";
                    return true;
                } else {
                    msg.textContent = "❌ Passwords do not match";
                    msg.className = "text-danger small";
                    return false;
                }
            }

            function updateCheck(element, valid) {
                element.textContent = (valid ? "✅ " : "❌ ") + element.textContent.slice(2);
                element.classList.toggle("text-success", valid);
                element.classList.toggle("text-danger", !valid);
            }

            function updateEditSaveButton() {
                const passwordValid = validateEditPassword();
                const confirmValid = validateEditConfirmPassword();
                const requiredFieldsFilled = [...document.querySelectorAll("#editForm [required]")]
                    .every(input => input.value.trim() !== "");
                editSaveBtn.disabled = !(passwordValid && confirmValid && requiredFieldsFilled);
            }

            editPasswordInput.addEventListener("input", updateEditSaveButton);
            editConfirmInput.addEventListener("input", updateEditSaveButton);
            document.querySelectorAll("#editForm [required]").forEach(input => {
                input.addEventListener("input", updateEditSaveButton);
            });
        </script>

        <script>
            const apiBase = '/api/users';
            const table = document.getElementById('usersTable');
            const tbody = document.getElementById('userTbody');
            const emptyMsg = document.getElementById('emptyMsg');
            const dlg = document.getElementById('newDialog');
            const newBtn = document.getElementById('newBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const form = document.getElementById('newForm');
            const err = document.getElementById('formError');
            const modalEl = document.getElementById('userModal');
            const userModal = new bootstrap.Modal(modalEl);
            const checkUsernameBtn = document.getElementById('checkUsernameBtn');
            const userNameInput = document.getElementById('userName');
            const formError = document.getElementById('formError');

            const editModal = new bootstrap.Modal(document.getElementById('editModal'));

            async function loadGroupsIntoSelect(selectId, selectedGroupId) {
                const res = await fetch('/api/groups');
                if (!res.ok) return;
                const groups = await res.json();

                const select = document.getElementById(selectId);
                select.innerHTML = "";

                groups.forEach(group => {
                    const opt = document.createElement("option");
                    opt.value = group.id;
                    opt.textContent = group.name;
                    if (group.id === selectedGroupId) {
                        opt.selected = true;
                    }
                    select.appendChild(opt);
                });
            }

            function editUser(id, first, last, email, userName, groupId) {
                document.getElementById('editUserId').value = id;
                document.getElementById('editFirstName').value = first;
                document.getElementById('editLastName').value = last;
                document.getElementById('editEmail').value = email;
                document.getElementById('editUserName').value = userName;

                // Load groups with the user's current group selected
                loadGroupsIntoSelect("editGroup", groupId);

                document.getElementById('editFormError').hidden = true;
                editModal.show();
            }

            document.getElementById('editForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const id = document.getElementById('editUserId').value;
                const updatedUser = {
                    firstName: document.getElementById('editFirstName').value,
                    lastName: document.getElementById('editLastName').value,
                    email: document.getElementById('editEmail').value,
                    userName: document.getElementById('editUserName').value, // still sent, but uneditable
                    groupId: document.getElementById('editGroup').value
                };

                const res = await fetch(`/api/users/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedUser)
                });

                if (res.ok) {
                    editModal.hide();
                    await loadUsers(); // refresh the table
                } else {
                    document.getElementById('editFormError').textContent = "Failed to update user.";
                    document.getElementById('editFormError').hidden = false;
                }
            });


            let deleteUserId = null; // store the user ID for deletion
            const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            const deleteMessage = document.getElementById('deleteMessage');
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

            function deleteUser(id, firstName, lastName) {
                deleteUserId = id;
                deleteMessage.textContent = `Are you sure you want to delete ${firstName} ${lastName}?`;
                deleteModal.show();
            }

            confirmDeleteBtn.addEventListener('click', async () => {
                if (deleteUserId) {
                    const res = await fetch(`/api/users/${deleteUserId}`, { method: 'DELETE' });
                    if (res.ok) {
                        await loadUsers();
                    } else {
                        alert("Failed to delete user."); // optional error handling
                    }
                }
                deleteUserId = null;
                deleteModal.hide();
            });

            let usernameExists = false;

            // Check Username button
            checkUsernameBtn.addEventListener('click', async () => {
                const username = userNameInput.value.trim();
                if (!username) return alert('Please enter a username to check.');

                try {
                    const res = await fetch(`/api/users/check-username?userName=${encodeURIComponent(username)}`);
                    const data = await res.json();

                    if (data.available) {
                        usernameExists = true;
                        alert('Username already exists!');
                    } else {
                        usernameExists = false;
                        alert('Username is available.');
                    }
                } catch (err) {
                    console.error(err);
                    alert('Error checking username.');
                }
            });
            const pageSizeSelect = document.getElementById('pageSizeSelect');
            let pageSize = parseInt(pageSizeSelect.value);
            let currentPage = 1;
            let totalUsers = 0;

            async function loadGroups() {
                const res = await fetch('/api/groups');
                const groups = await res.json();
                const select = document.getElementById('groupId');
                select.innerHTML = groups.map(g =>
                    `<option value="${g.id}">${escapeHtml(g.name)}</option>`
                ).join('');
            }


            async function loadUsers() {
                const res = await fetch(`${apiBase}?page=${currentPage}&pageSize=${pageSize}`);

                if (!res.ok) {
                    tbody.innerHTML = '';
                    table.hidden = true;
                    emptyMsg.hidden = false;
                    return;
                }

                const tbody = document.querySelector("#usersTable tbody");
                tbody.innerHTML = "";
                table.classList.add('d-none');
                emptyMsg.classList.add('d-none');

                const users = await res.json();
                if (users.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="4" class="text-center">No users found</td></tr>`;
                    table.hidden = false;
                } else {
                    tbody.innerHTML = users.map(u => `
                                                <tr>
                                                <td>${escapeHtml(u.firstName)}</td>
                                                <td>${escapeHtml(u.lastName)}</td>
                                                <td>${escapeHtml(u.email)}</td>
                                                <td>${escapeHtml(u.userName)}</td>
                                                <td>${escapeHtml(u.group)}</td>
                                                <td>
                                                <button class="btn btn-sm btn-primary" onclick="editUser(${u.id}, '${escapeHtml(u.firstName)}', '${escapeHtml(u.lastName)}', '${escapeHtml(u.email)}')">Edit</button>
                                                <button class="btn btn-sm btn-danger"
                                                    onclick="deleteUser(${u.id}, '${escapeHtml(u.firstName)}', '${escapeHtml(u.lastName)}')">
                                                Delete
                                                </button>
                                                </td>
                                                </tr>
                                                `).join('');

                    totalUsers = users.length;
                    const totalPages = Math.ceil(totalUsers / pageSize);
                    renderPagination(totalPages);
                }

                const has = users.length > 0;
                emptyMsg.hidden = has;
                table.classList.remove('d-none');
            }

            function deleteUser(id, firstName, lastName) {
                deleteUserId = id;
                deleteMessage.textContent = `Are you sure you want to delete ${firstName} ${lastName}?`;
                deleteModal.show();
            }

            function renderPagination(totalPages) {
                const container = document.getElementById('paginationControls');
                container.innerHTML = '';

                const prevBtn = `<button class="btn btn-outline-secondary me-2" ${currentPage === 1 ? 'disabled' : ''} onclick="goToPage(${currentPage - 1})">Prev</button>`;
                container.insertAdjacentHTML('beforeend', prevBtn);

                for (let i = 1; i <= totalPages; i++) {
                    const active = i === currentPage ? 'btn-primary' : 'btn-outline-secondary';
                    container.insertAdjacentHTML('beforeend',
                        `<button class="btn ${active} me-1" onclick="goToPage(${i})">${i}</button>`
                    );
                }

                const nextBtn = `<button class="btn btn-outline-secondary ms-2" ${currentPage === totalPages ? 'disabled' : ''} onclick="goToPage(${currentPage + 1})">Next</button>`;
                container.insertAdjacentHTML('beforeend', nextBtn);
            }

            function goToPage(page) {
                currentPage = page;
                loadUsers();
            }


            function escapeHtml(s) {
                return String(s ?? '').replace(/[&<>"']/g, m => ({
                    '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
                }[m]));
            }

            document.getElementById('newBtn').addEventListener('click', () => {
                form.reset();
                err.hidden = true;
                form.userId.value = '';
                modalTitle.textContent = 'New User';

                // Show password field when creating a new user
                document.getElementById("password").parentElement.style.display = "block";

                userModal.show();
            });

            pageSizeSelect.addEventListener('change', () => {
                pageSize = parseInt(pageSizeSelect.value);
                currentPage = 1; // reset to first page when page size changes
                loadUsers();
            });

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                formError.hidden = true;

                const payload = {
                    firstName: newForm.firstName.value.trim(),
                    lastName: newForm.lastName.value.trim(),
                    email: newForm.email.value.trim(),
                    userName: newForm.userName.value.trim(),
                    password: newForm.password.value.trim(),
                    groupId: newForm.groupId.value
                };

                // Basic field validation
                if (!payload.firstName || !payload.lastName || !payload.email || !payload.userName || !payload.password) {
                    formError.textContent = 'All fields are required.';
                    formError.hidden = false;
                    return;
                }

                // **Always check if username exists before saving**
                try {
                    const resCheck = await fetch(`/api/users/check-username?userName=${encodeURIComponent(payload.userName)}`);
                    const data = await resCheck.json();
                    if (data.exists) {
                        alert('Cannot save: Username already exists.');
                        return;
                    }
                } catch (err) {
                    console.error(err);
                    alert('Error checking username.');
                    return;
                }

                // Proceed with creating the user
                const res = await fetch('/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) {
                    const msg = await res.text();
                    formError.textContent = msg || 'Failed to save user.';
                    formError.hidden = false;
                    return;
                }

                // Close the modal
                const userModalEl = document.getElementById('userModal');
                const userModal = bootstrap.Modal.getInstance(userModalEl);
                userModal.hide();

                // Reload the table
                await loadUsers();
            });


            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                err.hidden = true;

                const id = form.userId.value;

                const payload = {
                    firstName: form.firstName.value.trim(),
                    lastName: form.lastName.value.trim(),
                    email: form.email.value.trim(),
                };

                // Only include password when creating a new user
                if (!id) {
                    payload.password = form.password.value.trim();
                }

                if (!payload.firstName || !payload.lastName || !payload.email || (!id && !payload.password)) {
                    err.textContent = 'All fields are required.';
                    err.hidden = false;
                    return;
                }

                // Added to following so it can handle update and new users
                //const id = form.userId.value;
                const method = id ? 'PUT' : 'POST';
                const url = id ? `${apiBase}/${id}` : apiBase;

                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) {
                    const msg = await res.text();
                    err.textContent = msg || 'Failed to save user.';
                    err.hidden = false;
                    return;
                }

                dlg.close();
                await loadUsers();
            });
            loadGroups();
            loadUsers();
        </script>
</body>
</html>
